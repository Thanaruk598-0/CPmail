<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ดูแบบฟอร์มทั้งหมด</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --radius: 8px;
      --card-border:#e6e9ef;
      --section-bg:#f6f8fc;
      --thead-bg:#eef2f7;
      --num-black:#111;
    }
    body{ background: var(--section-bg); font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; color:#16202a; }
    .page-title{ font-weight:700; color:#1f2d3d; }
    .summary-card{ border:1px solid var(--card-border); border-radius:var(--radius); background:#fff; }
    .summary-card h6{ font-size:.9rem; color:#6b7280; margin-bottom:.25rem; }
    .summary-card p{ font-size:1.6rem; font-weight:700; margin:0; color:var(--num-black); }
    .toolbar .btn{ border-radius:var(--radius); padding:.55rem 1rem; }
    .table thead{ background:var(--thead-bg); }
    .table, .card{ border-radius:var(--radius); }
    .table tbody td{ vertical-align: middle; }
    .table td time, .table td .num { color:var(--num-black); }
    .badge.rounded-pill{ padding:.45rem .75rem; font-weight:600; border-radius:999px; }
    .btn-action{ padding:.35rem .65rem; border-radius:var(--radius); }
    .filter-label{ font-weight:600; color:#374151; }
    .pagination .page-link{ color:#111; }
    .pagination .active .page-link{ background:#0d6efd; border-color:#0d6efd; color:#fff; }
    @media print{ .no-print{ display:none !important; } }
    footer{ border-top:1px solid var(--card-border); background:#fff; color:#444; }
  </style>
</head>
<body>

  <%- include('../../partials/navbar', { user: currentUser, activeMenu: 'allForms' }) %>

  <%
    /* ====== ภาษาไทย ====== */
    const STATUS_TH = { approved:'อนุมัติแล้ว', pending:'รอดำเนินการ', rejected:'ถูกปฏิเสธ', cancelled:'ยกเลิกแล้ว' };
    const CATEGORY_TH = {
      Academic:'ด้านวิชาการ', Administrative:'ด้านบริหาร / งานธุรการ',
      Evaluation:'การประเมิน',  Request:'คำขอ / การร้องขอ',  Survey:'แบบสำรวจ'
    };
    const ROLE_TH = { student:'นักศึกษา', lecturer:'อาจารย์', admin:'ผู้ดูแลระบบ' };

    /* ====== ข้อมูล/สรุป (รองรับยังไม่ต่อ DB) ====== */
    const list = Array.isArray(forms) ? forms : [];
    const total = list.length;
    const approvedCount = list.filter(f => f.status === 'approved').length;
    const pendingCount  = list.filter(f => f.status === 'pending').length;
    const rejectedCount = list.filter(f => f.status === 'rejected').length;

    /* ====== Pagination (fallback ถ้าไม่ได้ส่งมาจาก route) ====== */
    const q = (typeof query !== 'undefined' && query) ? query : {};
    const currentPage = Number((typeof page !== 'undefined' ? page : 1));
    const totalP      = Number((typeof totalPages !== 'undefined' ? totalPages : 1));
    const prevPage    = currentPage > 1 ? currentPage - 1 : 1;
    const nextPage    = currentPage < totalP ? currentPage + 1 : totalP;
    function pageLink(p){
      const parts = [];
      for (const k in q){ if (Object.prototype.hasOwnProperty.call(q,k) && k !== 'page'){ parts.push(encodeURIComponent(k)+'='+encodeURIComponent(q[k])); } }
      parts.push('page='+encodeURIComponent(p));
      return '?'+parts.join('&');
    }
  %>

  <!-- ====== โซนส่งออก PDF ====== -->
  <div class="container py-4" id="exportArea">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="page-title mb-1">ดูแบบฟอร์มทั้งหมด</h3>
        <p class="text-muted mb-0">ติดตามและจัดการการส่งแบบฟอร์มทั้งหมดภายในระบบ</p>
      </div>
      <div class="toolbar no-print">
        <button id="btnExportPdf" class="btn btn-success">
          <i class="fa-solid fa-file-pdf me-1"></i> ส่งออก PDF
        </button>
      </div>
    </div>

    <!-- Summary -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="summary-card text-center p-3">
          <h6>จำนวนทั้งหมด</h6><p class="num"><%= total %></p>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="summary-card text-center p-3">
          <h6>อนุมัติแล้ว</h6><p class="num"><%= approvedCount %></p>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="summary-card text-center p-3">
          <h6>รอดำเนินการ</h6><p class="num"><%= pendingCount %></p>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="summary-card text-center p-3">
          <h6>ถูกปฏิเสธ</h6><p class="num"><%= rejectedCount %></p>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4 no-print">
      <div class="card-body">
        <form method="GET" action="/forms" class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="filter-label">ค้นหา</label>
            <input type="text" name="search" value="<%= q.search || '' %>" class="form-control" placeholder="ค้นหาชื่อแบบฟอร์ม, ผู้ส่ง, รหัสฟอร์ม..." />
          </div>
          <div class="col-md-3">
            <label class="filter-label">สถานะ</label>
            <select name="status" class="form-select">
              <option value="">ทุกสถานะ</option>
              <option value="approved" <%= q.status==='approved' ? 'selected' : '' %>>อนุมัติแล้ว</option>
              <option value="pending"  <%= q.status==='pending'  ? 'selected' : '' %>>รอดำเนินการ</option>
              <option value="rejected" <%= q.status==='rejected' ? 'selected' : '' %>>ถูกปฏิเสธ</option>
              <option value="cancelled" <%= q.status==='cancelled' ? 'selected' : '' %>>ยกเลิกแล้ว</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="filter-label">ประเภท (หมวดหมู่)</label>
            <select name="type" class="form-select">
              <option value="">ทุกประเภท</option>
              <% Object.keys(CATEGORY_TH).forEach(k => { %>
                <option value="<%= k %>" <%= q.type===k ? 'selected' : '' %>><%= CATEGORY_TH[k] %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-2 d-flex gap-2">
            <button type="submit" class="btn btn-primary w-50">ค้นหา</button>
            <a href="/forms" class="btn btn-outline-secondary w-50">ล้าง</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">รายการแบบฟอร์ม</h5>
          <small class="text-muted">ทั้งหมด <span class="num"><%= total %></span> รายการ</small>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th class="no-print"><input type="checkbox" id="selectAll"></th>
                <th>รหัสฟอร์ม</th>
                <th>ชื่อฟอร์ม</th>
                <th>ผู้ส่ง</th>
                <th>ประเภท</th>
                <th>ส่งเมื่อ</th>
                <th>สถานะ</th>
                <th class="no-print">การดำเนินการ</th>
              </tr>
            </thead>
            <tbody>
            <% if (list.length > 0) { %>
              <% list.forEach(f => { %>
                <tr>
                  <!-- เลือกหลายรายการ -->
                  <td class="no-print">
                    <input type="checkbox" name="ids" value="<%= f._id %>">
                  </td>

                  <!-- รหัสฟอร์ม -->
                  <td class="num"><%= f.formId || (f._id ? ("F" + String(f._id).slice(-6).toUpperCase()) : "-") %></td>

                  <!-- ชื่อฟอร์ม -->
                  <td><%= f.template?.title || "ไม่ระบุชื่อ" %></td>

                  <!-- ผู้ส่ง (ชื่อ + เมล + บทบาท) -->
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <img src="<%= f.submitter?.avatarUrl || 'https://via.placeholder.com/32' %>" alt="" width="32" height="32" class="rounded-circle"/>
                      <div>
                        <div class="fw-semibold"><%= f.submitter?.name || 'ไม่ระบุ' %></div>
                        <small class="text-muted"><%= f.submitter?.email || '' %></small><br>
                        <small class="text-muted"><%= ROLE_TH[f.submitter?.role] || '' %></small>
                      </div>
                    </div>
                  </td>

                  <!-- ประเภท -->
                  <td>
                    <span class="badge rounded-pill bg-primary-subtle text-primary">
                      <%= CATEGORY_TH[f.template?.category] || f.template?.category || "-" %>
                    </span>
                  </td>

                  <!-- ส่งเมื่อ -->
                  <td>
                    <time class="num"><%= f.submittedAt ? f.submittedAt.toLocaleDateString('th-TH') : '-' %></time>
                    <small class="text-muted"><%= f.submittedAt ? f.submittedAt.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) : '' %></small>
                  </td>

                  <!-- สถานะ -->
                  <td>
                    <% const s = f.status; %>
                    <% if (s==='approved'){ %>
                      <span class="badge rounded-pill bg-success-subtle text-success"><%= STATUS_TH[s] %></span>
                    <% } else if (s==='pending'){ %>
                      <span class="badge rounded-pill bg-warning-subtle text-warning"><%= STATUS_TH[s] %></span>
                    <% } else if (s==='rejected'){ %>
                      <span class="badge rounded-pill bg-danger-subtle text-danger"><%= STATUS_TH[s] %></span>
                    <% } else { %>
                      <span class="badge rounded-pill bg-secondary-subtle text-secondary"><%= STATUS_TH[s] || s %></span>
                    <% } %>
                  </td>

                  <!-- การดำเนินการ -->
                  <td class="no-print">
                    <a href="/forms/view/<%= f._id %>" class="btn btn-outline-primary btn-action me-1">
                      <i class="fa-regular fa-eye"></i> ดู
                    </a>
                    <form action="/forms/<%= f._id %>/approve" method="POST" style="display:inline;">
                      <button type="submit" class="btn btn-success btn-action me-1"
                              onclick="return confirm('ยืนยันอนุมัติแบบฟอร์มนี้หรือไม่?');">
                        <i class="fa-regular fa-circle-check"></i> อนุมัติ
                      </button>
                    </form>
                    <form action="/forms/<%= f._id %>/reject" method="POST" style="display:inline;">
                      <button type="submit" class="btn btn-outline-danger btn-action"
                              onclick="return confirm('ยืนยันปฏิเสธแบบฟอร์มนี้หรือไม่?');">
                        <i class="fa-regular fa-circle-xmark"></i> ปฏิเสธ
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="8" class="text-center text-muted py-4">ยังไม่มีข้อมูลแบบฟอร์ม</td></tr>
            <% } %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <nav class="no-print">
          <ul class="pagination justify-content-end mb-0">
            <li class="page-item <%= currentPage <= 1 ? 'disabled' : '' %>">
              <a class="page-link" href="<%= pageLink(prevPage) %>">ก่อนหน้า</a>
            </li>
            <% for (let p=Math.max(1, currentPage-2); p<=Math.min(totalP, currentPage+2); p++){ %>
              <li class="page-item <%= p===currentPage ? 'active' : '' %>">
                <a class="page-link" href="<%= pageLink(p) %>"><span class="num"><%= p %></span></a>
              </li>
            <% } %>
            <li class="page-item <%= currentPage >= totalP ? 'disabled' : '' %>">
              <a class="page-link" href="<%= pageLink(nextPage) %>">ถัดไป</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div><!-- /#exportArea -->

  <!-- Footer -->
  <footer class="py-3 mt-4">
    <div class="container d-flex justify-content-between">
      <div>© <%= new Date().getFullYear() %> คณะวิทยาการคอมพิวเตอร์ มหาวิทยาลัยขอนแก่น</div>
      <div class="text-muted">FormEase Admin</div>
    </div>
  </footer>

  <!-- PDF Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // Select all
    document.getElementById('selectAll')?.addEventListener('click', function () {
      document.querySelectorAll("input[name='ids']").forEach(cb => cb.checked = this.checked);
    });

    // Export PDF (เฉพาะ #exportArea)
    document.getElementById('btnExportPdf')?.addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const el = document.getElementById('exportArea');
      const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
      const imgData = canvas.toDataURL('image/png');

      const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pageWidth - 16;                     // margin 8mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      if (imgHeight <= pageHeight - 16){
        pdf.addImage(imgData, 'PNG', 8, 8, imgWidth, imgHeight, undefined, 'FAST');
      } else {
        // รองรับหลายหน้า
        let position = 8;
        let heightLeft = imgHeight;
        while (heightLeft > 0) {
          pdf.addImage(imgData, 'PNG', 8, position, imgWidth, imgHeight, undefined, 'FAST');
          heightLeft -= (pageHeight - 16);
          if (heightLeft > 0) { pdf.addPage(); position = 8 - (imgHeight - heightLeft); }
        }
      }
      pdf.save('forms.pdf');
    });
  </script>
</body>
</html>
