<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Manage Form Templates</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

  <%- include('../../partials/navbar', { currentUser: currentUser, activeMenu: 'formTemplates' }) %>

    <div class="container">
      <h1 class="mb-4">จัดการเทมเพลตแบบฟอร์ม</h1>
      <p>สร้างและจัดการเทมเพลตแบบฟอร์มด้วยการควบคุมการเข้าถึงตามบทบาท</p>

      <!-- สรุปข้อมูล -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center p-3">
            <h5>เทมเพลตทั้งหมด</h5>
            <p class="fs-4 fw-bold">
              <%= templates.length %>
            </p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center p-3">
            <h5>เทมเพลตที่เปิดใช้งาน</h5>
            <p class="fs-4 fw-bold">
              <%= templates.filter(t=> t.status === "Active").length %>
            </p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center p-3">
            <h5>หมวดหมู่</h5>
            <p class="fs-4 fw-bold">
              <%= [...new Set(templates.map(t=> t.category))].length %>
            </p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center p-3">
            <h5>อัพเดทล่าสุด</h5>
            <p class="fs-4 fw-bold">
              <%= templates.filter(t=> t.updatedAt).length %>
            </p>
          </div>
        </div>
      </div>

      <!-- ปุ่มสร้าง template -->
      <div class="mb-3 text-end">
        <a href="/form-templates/new" class="btn btn-primary">+ สร้างเทมเพลต</a>
      </div>

      <!-- Search / Filter -->

      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <form class="row g-3" method="GET" action="/form-templates">

            <!-- Search -->
            <div class="col-md-4">
              <label class="form-label fw-semibold">ค้นหา</label>
              <input type="text" name="search" value="<%= query?.search || '' %>" class="form-control"
                placeholder="ค้นหาตามชื่อเทมเพลต...">
            </div>

            <!-- Category -->
            <div class="col-md-3">
              <label class="form-label fw-semibold">หมวดหมู่</label>
              <select name="category" class="form-select">
                <option value="">ทุกหมวดหมู่</option>
                <% categories.forEach(cat=> { %>
                  <option value="<%= cat.value %>" <%=query && query.category===cat.value ? 'selected' : '' %>>
                    <%= cat.label %>
                  </option>
                  <% }) %>
              </select>

            </div>

            <% const STATUS_LABELS_TH={ Active: "เปิดใช้งาน" , Inactive: "ปิดใช้งาน" , Draft: "ฉบับร่าง" }; %>

              <!-- Status -->
              <div class="col-md-3">
                <label class="form-label fw-semibold">สถานะ</label>
                <select name="status" class="form-select">
                  <option value="">ทุกสถานะ</option>
                  <option value="Active" <%=query?.status==='Active' ? 'selected' : '' %>>เปิดใช้งาน</option>
                  <option value="Inactive" <%=query?.status==='Inactive' ? 'selected' : '' %>>ปิดใช้งาน</option>
                  <option value="Draft" <%=query?.status==='Draft' ? 'selected' : '' %>>ฉบับร่าง</option>
                </select>

              </div>

              <!-- ปุ่ม Filter + Clear -->
              <div class="col-md-2 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary w-50">ค้นหา</button>
                <a href="/form-templates" class="btn btn-outline-secondary w-50">ล้าง</a>
              </div>
          </form>

          <div class="mt-2 text-muted small">
            กำลังโชว์ <%= templates.length %> เทมเพลต
          </div>
        </div>
      </div>


      <!-- ตาราง Templates -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">แบบฟอร์มทั้งหมด</h5>
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>ชื่อฟอร์ม</th>
                <th>หมวดหมู่</th>
                <th>บทบาทที่อนุญาต</th>
                <th>เขตข้อมูล</th>
                <th>แก้ไขครั้งล่าสุด</th>
                <th>สถานะ</th>
                <th>การดำเนินการ</th>
              </tr>
            </thead>
            <tbody>
              <% if (templates && templates.length> 0) { %>
                <% templates.forEach(template=> { %>
                  <tr>
                    <!-- Template Name + Description -->
                    <td>
                      <strong>
                        <%= template.title %>
                      </strong><br>
                      <small class="text-muted">
                        <%= template.description %>
                      </small>
                    </td>

                    <!-- Category -->
                    <td>
                      <span class="badge bg-primary">
                        <%= labels[template.category] || template.category %>
                      </span>
                    </td>

                    <!-- Allowed Roles -->
                    <td>
                      <% template.allowedRoles.forEach(role=> { %>
                        <span class="badge bg-info text-dark me-1">
                          <%= role %>
                        </span>
                        <% }) %>
                    </td>

                    <!-- Fields -->
                    <td>
                      <%= template.fields.length %> fields
                    </td>

                    <!-- Last Modified -->
                    <td>
                      <%= template.updatedAt ? template.updatedAt.toLocaleDateString("th-TH") : '-' %>
                    </td>

                    <!-- Status -->
                    <td>
                      <% const s=template.status; const labelTH=STATUS_LABELS_TH[s] || s; const cls=(s==="Active" )
                        ? "bg-success" : (s==="Draft" ) ? "bg-warning" : "bg-secondary" ; %>
                        <span class="badge <%= cls %>">
                          <%= labelTH %>
                        </span>
                    </td>


                    <!-- Actions -->
                    <td>
                      <!-- View -->
                      <a href="/form-templates/<%= template._id %>/view" class="text-success me-2" title="View">
                        <i class="fas fa-eye"></i>
                      </a>

                      <!-- Edit -->
                      <a href="/form-templates/<%= template._id %>/edit" class="text-warning me-2" title="Edit">
                        <i class="fas fa-edit"></i>
                      </a>

                      <!-- Clone -->
                      <form action="/form-templates/<%= template._id %>/clone" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-link text-info p-0 me-2" title="Clone">
                          <i class="fas fa-copy"></i>
                        </button>
                      </form>

                      <!-- Delete -->
                      <form action="/form-templates/<%= template._id %>/delete" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-link text-danger p-0" title="Delete"
                          onclick="return confirm('Are you sure?')">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </td>
                  </tr>
                  <% }) %>
                    <% } else { %>
                      <tr>
                        <td colspan="7" class="text-center text-muted">ไม่พบเทมเพลตแบบฟอร์ม</td>
                      </tr>
                      <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

</body>

</html>