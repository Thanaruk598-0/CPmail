<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>จัดการผู้ใช้</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .header-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
    .header-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 5px; }
    .header-subtitle { font-size: 0.9rem; opacity: 0.9; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid; text-align: center; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card.total { border-left-color: #dc3545; }
    .stat-card.active { border-left-color: #198754; }
    .stat-card.lecturers { border-left-color: #0dcaf0; }
    .stat-card.pending { border-left-color: #6c757d; }
    .stat-number { font-size: 2rem; font-weight: bold; color: #212529; }
    .stat-label { font-size: 0.85rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }
    .filter-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .table thead th { background: #f8f9fa; border: none; font-weight: 500; color: #495057; }
    .table tbody td { vertical-align: middle; }
    .role-badge { padding: 4px 8px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
    .role-student { background: #0d6efd; color: white; }
    .role-lecturer { background: #198754; color: white; }
    .role-admin { background: #dc3545; color: white; }
    .avatar-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  </style>
</head>
<body>

  <%- include('../partials/navbar', { currentUser: currentUser, activeMenu: activeMenu }) %>

  <div class="container mt-4">
    <div class="header-section">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="header-title">แผงควบคุมผู้ใช้</div>
          <div class="header-subtitle">จัดการผู้ใช้และสถิติระบบของคุณ</div>
        </div>
        <div class="col-md-4 text-end">
          <span class="badge bg-light text-dark fs-6">โหมดผู้ดูแลระบบ</span>
        </div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card total">
        <div class="stat-number"><%= stats.totalUsers %></div>
        <div class="stat-label">ผู้ใช้ทั้งหมด</div>
      </div>
      <div class="stat-card active">
        <div class="stat-number"><%= stats.activeUsers %></div>
        <div class="stat-label">ผู้ใช้ที่ใช้งาน</div>
      </div>
      <div class="stat-card student">
        <div class="stat-number"><%= stats.studentCount %></div>
        <div class="stat-label">นักศึกษา</div>
      </div>
      <div class="stat-card lecturers">
        <div class="stat-number"><%= stats.lecturerCount %></div>
        <div class="stat-label">อาจารย์</div>
      </div>
      <div class="stat-card admin">
        <div class="stat-number"><%= stats.adminCount %></div>
        <div class="stat-label">ผู้ดูแลระบบ</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-number"><%= stats.pending %></div>
        <div class="stat-label">รอเปลี่ยนรหัสผ่าน</div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">ผู้ใช้ทั้งหมด</h5>
          <a href="/manageUser/add" class="btn btn-primary">เพิ่มผู้ใช้ใหม่</a>
        </div>

        <div class="filter-section">
          <form method="GET" action="/manageUser/list" class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label">ค้นหา</label>
              <input type="text" name="search" class="form-control" placeholder="ค้นหาด้วยชื่อหรืออีเมล" value="<%= search %>">
            </div>
            <div class="col-md-2">
              <label class="form-label">บทบาท</label>
              <select name="role" class="form-select">
                <option value="all" <%= role === 'all' ? 'selected' : '' %>>ทุกบทบาท</option>
                <option value="student" <%= role === 'student' ? 'selected' : '' %>>นักศึกษา</option>
                <option value="lecturer" <%= role === 'lecturer' ? 'selected' : '' %>>อาจารย์</option>
                <option value="admin" <%= role === 'admin' ? 'selected' : '' %>>ผู้ดูแลระบบ</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-outline-primary w-100">ค้นหา</button>
            </div>
          </form>
        </div>

        <div class="table-container">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>ชื่อ-สกุล</th>
                <th>อีเมล</th>
                <th>รหัสนักศึกษา/รหัสอาจารย์</th>
                <th>บทบาท</th>
                <th>ชั้นปี</th>
                <th>สาขา</th>
                <th>การจัดการ</th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach(user => { %>
                <tr>
                  <td>
                    <img src="<%= user.avatarUrl || '/uploads/default.jpg' %>" alt="Avatar" class="avatar-img me-2">
                    <%= user.name %>
                  </td>
                  <td><%= user.email %></td>
                  <td><%= user.universityId %></td>
                  <td>
                    <span class="role-badge role-<%= user.role %>">
                      <% if(user.role === 'student'){ %>นักศึกษา<% } else if(user.role === 'lecturer'){ %>อาจารย์<% } else if(user.role === 'admin'){ %>ผู้ดูแลระบบ<% } else { %><%= user.role %><% } %>
                    </span>
                  </td>
                  <td><%= user.yearOfStudy || '-' %></td>
                  <td><%= user.major || '-' %></td>
                  <td>
                    <a href="/manageUser/edit/<%= user._id %>" class="btn btn-sm btn-outline-primary me-1">แก้ไข</a>
                    <form method="POST" action="/manageUser/delete/<%= user._id %>" style="display:inline;" onsubmit="return confirm('ยืนยันการลบ?')">
                      <button type="submit" class="btn btn-sm btn-outline-danger">ลบ</button>
                    </form>
                  </td>
                </tr>
              <% }); %>
              <% if (users.length === 0) { %>
                <tr><td colspan="7" class="text-center py-4">ไม่พบผู้ใช้</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</body>
</html>